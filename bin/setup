#!/usr/bin/env node

import fs from "fs";
import path from "path";
import { createRequire } from "module";

// Support both ESM and CJS imports for js-yaml
const require = createRequire(import.meta.url);
const YAML = require("yaml");

const projectRoot = process.cwd();

console.log("Setting up Forge SQL CLI in this project...");

// Detect consumer project type
let isEsm = false;
let isTypeScript = fs.existsSync(path.join(projectRoot, "tsconfig.json"));

try {
  const pkgPath = path.join(projectRoot, "package.json");
  if (fs.existsSync(pkgPath)) {
    const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));
    if (pkg.type === "module") {
      isEsm = true;
    }
  }
} catch (e) {
  // Ignore errors reading package.json
}

// 1. Create src/fsql file
const srcDir = path.join(projectRoot, "src");
if (!fs.existsSync(srcDir)) {
  fs.mkdirSync(srcDir, { recursive: true });
}

const extension = isTypeScript ? "ts" : isEsm ? "js" : "js";
// If it's CJS, we still use .js but different content
const fsqlPath = path.join(srcDir, `fsql.${extension}`);

let fsqlContent = "";
if (isEsm || isTypeScript) {
  fsqlContent = `import { executeSql } from 'forge-fsql';

export { executeSql };
`;
} else {
  fsqlContent = `const { executeSql } = require('forge-fsql');

module.exports = { executeSql };
`;
}

fs.writeFileSync(fsqlPath, fsqlContent);
console.log(`✓ Created src/fsql.${extension}`);

// 2. Update manifest.yaml or manifest.yml
let manifestPath = path.join(projectRoot, "manifest.yml");
if (!fs.existsSync(manifestPath)) {
  manifestPath = path.join(projectRoot, "manifest.yaml");
}

if (!fs.existsSync(manifestPath)) {
  console.error(
    "Error: Could not find manifest.yml or manifest.yaml in the current directory.",
  );
  process.exit(1);
}

let doc;
try {
  const fileContents = fs.readFileSync(manifestPath, "utf8");
  doc = YAML.parseDocument(fileContents);
} catch (e) {
  console.error("Error reading manifest:", e);
  process.exit(1);
}

if (!doc.contents) {
  doc.contents = doc.createNode({});
}

if (!doc.has("modules")) {
  doc.set("modules", doc.createNode({}));
}

const modules = doc.get("modules");

// Ensure function is an array
const functionKey = "executeSql";
if (!modules.has("function")) {
  modules.set("function", doc.createNode([]));
}

let functions = modules.get("function");

// If it's somehow not a sequence, convert it (though unlikely in Forge)
if (!YAML.isSeq(functions)) {
  const obj = functions.toJSON();
  functions = doc.createNode(
    Object.entries(obj).map(([key, val]) => ({ key, ...val })),
  );
  modules.set("function", functions);
}

const handlerName = "fsql.executeSql";
let functionExists = functions.items.find((f) => {
  const js = f.toJSON();
  return js && js.key === functionKey;
});

if (!functionExists) {
  functions.add(
    doc.createNode({
      key: functionKey,
      handler: handlerName,
    }),
  );
  console.log(
    `✓ Added function:${functionKey} with handler ${handlerName} to manifest`,
  );
} else {
  // If it's a Pair (map item) or just a Map in the sequence
  if (YAML.isMap(functionExists)) {
    functionExists.set("handler", handlerName);
  } else {
    // Should not happen with doc.createNode above, but for safety:
    const idx = functions.items.indexOf(functionExists);
    functions.set(
      idx,
      doc.createNode({ key: functionKey, handler: handlerName }),
    );
  }
  console.log(
    `✓ Updated function:${functionKey} handler to ${handlerName} in manifest`,
  );
}

// Ensure webtrigger is an array
const webtriggerKey = "execute-sql";
if (!modules.has("webtrigger")) {
  modules.set("webtrigger", doc.createNode([]));
}

let webtriggers = modules.get("webtrigger");
if (!YAML.isSeq(webtriggers)) {
  const obj = webtriggers.toJSON();
  webtriggers = doc.createNode(
    Object.entries(obj).map(([key, val]) => ({ key, ...val })),
  );
  modules.set("webtrigger", webtriggers);
}

let webtriggerExists = webtriggers.items.find((w) => {
  const js = w.toJSON();
  return js && js.key === webtriggerKey;
});

if (!webtriggerExists) {
  webtriggers.add(
    doc.createNode({
      key: webtriggerKey,
      function: functionKey,
    }),
  );
  console.log(`✓ Added webtrigger:${webtriggerKey} to manifest`);
} else {
  if (YAML.isMap(webtriggerExists)) {
    webtriggerExists.set("function", functionKey);
  } else {
    const idx = webtriggers.items.indexOf(webtriggerExists);
    webtriggers.set(
      idx,
      doc.createNode({ key: webtriggerKey, function: functionKey }),
    );
  }
  console.log(
    `✓ Ensured webtrigger:${webtriggerKey} points to function ${functionKey}`,
  );
}

try {
  fs.writeFileSync(manifestPath, doc.toString());
  console.log("✓ Updated manifest file successfully");
} catch (e) {
  console.error("Error writing manifest:", e);
  process.exit(1);
}

console.log("\nSetup completed successfully!");
console.log(
  "You can now use the forge-fsql CLI to interact with your Forge SQL database.",
);
