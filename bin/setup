#!/usr/bin/env node

import fs from "fs";
import path from "path";
import { createRequire } from "module";

// Support both ESM and CJS imports for js-yaml
const require = createRequire(import.meta.url);
const yaml = require("js-yaml");

const projectRoot = process.cwd();

console.log("Setting up Forge SQL CLI in this project...");

// Detect consumer project type
let isEsm = false;
let isTypeScript = fs.existsSync(path.join(projectRoot, "tsconfig.json"));

try {
  const pkgPath = path.join(projectRoot, "package.json");
  if (fs.existsSync(pkgPath)) {
    const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));
    if (pkg.type === "module") {
      isEsm = true;
    }
  }
} catch (e) {
  // Ignore errors reading package.json
}

// 1. Create src/fsql file
const srcDir = path.join(projectRoot, "src");
if (!fs.existsSync(srcDir)) {
  fs.mkdirSync(srcDir, { recursive: true });
}

const extension = isTypeScript ? "ts" : isEsm ? "js" : "js";
// If it's CJS, we still use .js but different content
const fsqlPath = path.join(srcDir, `fsql.${extension}`);

let fsqlContent = "";
if (isEsm || isTypeScript) {
  fsqlContent = `import { executeSql } from 'forge-fsql';

export { executeSql };
`;
} else {
  fsqlContent = `const { executeSql } = require('forge-fsql');

module.exports = { executeSql };
`;
}

fs.writeFileSync(fsqlPath, fsqlContent);
console.log(`✓ Created src/fsql.${extension}`);

// 2. Update manifest.yaml or manifest.yml
let manifestPath = path.join(projectRoot, "manifest.yml");
if (!fs.existsSync(manifestPath)) {
  manifestPath = path.join(projectRoot, "manifest.yaml");
}

if (!fs.existsSync(manifestPath)) {
  console.error(
    "Error: Could not find manifest.yml or manifest.yaml in the current directory.",
  );
  process.exit(1);
}

let manifest;
try {
  const fileContents = fs.readFileSync(manifestPath, "utf8");
  manifest = yaml.load(fileContents);
} catch (e) {
  console.error("Error reading manifest:", e);
  process.exit(1);
}

if (!manifest.modules) {
  manifest.modules = {};
}

// Ensure function is an array
const functionKey = "executeSql";
if (!manifest.modules.function) {
  manifest.modules.function = [];
} else if (!Array.isArray(manifest.modules.function)) {
  // Handle case where it might be a map (unlikely in Forge but just in case)
  manifest.modules.function = Object.entries(manifest.modules.function).map(
    ([key, val]) => ({ key, ...val }),
  );
}

const functionExists = manifest.modules.function.find(
  (f) => f.key === functionKey,
);
const handlerName = "fsql.executeSql";

if (!functionExists) {
  manifest.modules.function.push({
    key: functionKey,
    handler: handlerName,
  });
  console.log(
    `✓ Added function:${functionKey} with handler ${handlerName} to manifest`,
  );
} else {
  functionExists.handler = handlerName;
  console.log(
    `✓ Updated function:${functionKey} handler to ${handlerName} in manifest`,
  );
}

// Ensure webtrigger is an array
const webtriggerKey = "execute-sql";
if (!manifest.modules.webtrigger) {
  manifest.modules.webtrigger = [];
} else if (!Array.isArray(manifest.modules.webtrigger)) {
  manifest.modules.webtrigger = Object.entries(manifest.modules.webtrigger).map(
    ([key, val]) => ({ key, ...val }),
  );
}

const webtriggerExists = manifest.modules.webtrigger.find(
  (w) => w.key === webtriggerKey,
);
if (!webtriggerExists) {
  manifest.modules.webtrigger.push({
    key: webtriggerKey,
    function: functionKey,
  });
  console.log(`✓ Added webtrigger:${webtriggerKey} to manifest`);
} else {
  webtriggerExists.function = functionKey;
  console.log(
    `✓ Ensured webtrigger:${webtriggerKey} points to function ${functionKey}`,
  );
}

try {
  // Use a large enough lineWidth to prevent wrapping which can break Forge parsing sometimes
  const newYaml = yaml.dump(manifest, {
    indent: 2,
    lineWidth: -1,
    noRefs: true,
  });
  fs.writeFileSync(manifestPath, newYaml);
  console.log("✓ Updated manifest file successfully");
} catch (e) {
  console.error("Error writing manifest:", e);
  process.exit(1);
}

console.log("\nSetup completed successfully!");
console.log(
  "You can now use the forge-fsql CLI to interact with your Forge SQL database.",
);
